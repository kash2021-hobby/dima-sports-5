generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id          String  @id @default(cuid())
  phone       String  @unique
  email       String?
  mpinHash    String?
  role        String  @default("USER") // USER, PLAYER, COACH, ADMIN, REFEREE
  status      String  @default("ACTIVE") // ACTIVE, BLOCKED, INVITED, VERIFIED, SUSPENDED
  displayName String?

  // MPIN Security
  mpinAttempts    Int       @default(0)
  mpinLockedUntil DateTime?

  // OTP
  otpCode      String?
  otpExpiresAt DateTime?
  otpVerified  Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  player               Player?
  coach                Coach?
  application          PlayerApplication?
  createdCoaches       Coach[]             @relation("CoachCreator")
  reviewedApplications PlayerApplication[] @relation("ApplicationReviewer")
  verifiedDocuments    Document[]          @relation("DocumentVerifier")
  teamRequestsCreated  TeamCreationRequest[] @relation("TeamRequestRequester")
  teamRequestsReviewed TeamCreationRequest[] @relation("TeamRequestReviewer")
  createdTournaments   Tournament[]        @relation("TournamentCreator")
  publishedTournaments Tournament[]        @relation("TournamentPublisher")
  tournamentSnapshots  TournamentConfigSnapshot[] @relation("TournamentSnapshotCreator")
  refereeAssignments   TournamentRefereeAssignment[] @relation("UserRefereeAssignments")

  @@index([phone])
  @@index([role])
  @@index([status])
  @@map("users")
}

model OtpSession {
  id           String   @id @default(cuid())
  phone        String?
  otpCode      String?
  otpExpiresAt DateTime?
  verified     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("otp_sessions")
}

// ============================================
// PLAYER MODELS
// ============================================

model Player {
  id       String @id @default(cuid())
  playerId String @unique // Short public ID like #PLR-9F3A
  userId   String @unique
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Core Football Identity (Read-only after creation)
  dateOfBirth     DateTime?
  gender          String?
  primaryPosition String? // GK, DEF, MID, FWD
  dominantFoot    String? // LEFT, RIGHT, BOTH
  footballStatus  String    @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED

  // Personal Profile (Editable)
  displayName       String?
  photo             String?
  nickname          String?
  city              String?
  state             String?
  district          String?
  nationality       String?
  profileVisibility String  @default("PUBLIC") // PUBLIC, TEAM_ONLY, PRIVATE

  // Medical & Safety
  bloodGroup               String?
  allergies                String?
  chronicConditions        String?
  injuryStatus             String? // FIT, RECOVERING, UNFIT
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Tournament relations
  captainOfTournamentApplications TournamentApplication[] @relation("TournamentCaptain")
  tournamentApplicationPlayers    TournamentApplicationPlayer[] @relation("TournamentApplicationPlayer_Player")

  @@index([playerId])
  @@index([footballStatus])
  @@map("players")
}

model PlayerApplication {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status String @default("DRAFT") // DRAFT, SUBMITTED, UNDER_REVIEW, APPROVED, REJECTED, HOLD

  // Application Snapshot (Immutable after SUBMITTED)
  fullName                 String
  dateOfBirth              DateTime
  gender                   String
  sport                    String?  // FOOTBALL, CRICKET, BASKETBALL, OTHER
  // NOTE: frontend can send single or multi-select; if multi-select, we store JSON array as string
  primaryPosition          String?
  dominantFoot             String?
  height                   Int? // cm
  weight                   Int? // kg
  city                     String?
  state                    String?
  district                 String?
  pincode                  String?
  nationality              String?
  playerPhone              String?
  aadhaarNumber            String?
  // JSON array of Team IDs or Team codes, e.g. ["TEAM-1","TEAM-2"]
  preferredTeamIds         String?
  emergencyContactName     String?
  emergencyContactPhone    String
  emergencyContactRelation String?
  // JSON array of emergency contacts [{name, phone, relation}, ...]
  emergencyContactsJson    String?

  // Trial
  trialStatus String? // NOT_REQUIRED, PENDING, COMPLETED
  trialId     String? @unique
  trial       Trial?

  // Admin Review
  submittedAt          DateTime?
  reviewedBy           String?
  reviewedByUser       User?     @relation("ApplicationReviewer", fields: [reviewedBy], references: [id])
  reviewedAt           DateTime?
  rejectionReason      String?
  resubmissionAttempts Int       @default(0)
  lastResubmissionAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([trialStatus])
  @@map("player_applications")
}

// ============================================
// COACH MODELS
// ============================================

model Coach {
  id      String @id @default(cuid())
  coachId String @unique
  userId  String @unique
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Coaching Specialization
  sport              String  @default("FOOTBALL")
  ageGroups          String // JSON: ["U15", "U18", "Senior"]
  coachingRole       String // HEAD, ASSISTANT
  specializationTags String? // JSON array
  yearsExperience    Int?

  // Credentials
  licenseType        String? // AIFF, AFC, LOCAL, NONE
  licenseNumber      String?
  licenseIssuedBy    String?
  licenseExpiry      DateTime?
  licenseStatus      String    @default("PENDING") // PENDING, VERIFIED, REJECTED
  licenseDocumentUrl String?
  certificateUrl     String?

  // Status & Activation
  status        String    @default("INVITED") // INVITED, VERIFIED, ACTIVE, SUSPENDED, REMOVED
  inviteToken   String?   @unique // Unique token for invite link access
  invitedBy     String?
  invitedByUser User?     @relation("CoachCreator", fields: [invitedBy], references: [id])
  activatedBy   String?
  activatedAt   DateTime?

  // Profile
  displayName String?
  photo       String?
  bio         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trialEvaluations Trial[]
  teamAssignments  TeamCoach[]
  teamRequests     TeamCreationRequest[]
  tournamentApplications TournamentApplication[]

  @@index([coachId])
  @@index([status])
  @@index([sport])
  @@map("coaches")
}

model TeamCoach {
  id        String    @id @default(cuid())
  teamId    String
  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  coachId   String
  coach     Coach     @relation(fields: [coachId], references: [id], onDelete: Cascade)
  role      String // HEAD, ASSISTANT
  startDate DateTime  @default(now())
  endDate   DateTime?
  status    String    @default("ACTIVE") // ACTIVE, REMOVED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, coachId])
  @@index([coachId])
  @@index([teamId])
  @@map("team_coaches")
}

// ============================================
// TRIAL EVALUATION
// ============================================

model Trial {
  id            String            @id @default(cuid())
  applicationId String            @unique
  application   PlayerApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  status          String  @default("PENDING") // PENDING, COMPLETED, CANCELLED
  assignedCoachId String?
  assignedCoach   Coach?  @relation(fields: [assignedCoachId], references: [id])

  // Evaluation
  outcome     String? // RECOMMENDED, NOT_RECOMMENDED, NEEDS_RETEST
  notes       String?
  evaluatedAt DateTime?
  aadhaarVerified Boolean?

  // Scheduling
  scheduledDate DateTime?
  scheduledTime String?
  venue         String?

  // Medical form (Football)
  medicalChecklistJson   String? // JSON of coach medical checklist answers
  medicalVerified        Boolean?
  medicalReportDocumentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([assignedCoachId])
  @@map("trials")
}

// ============================================
// DOCUMENTS
// ============================================

model Document {
  id           String @id @default(cuid())
  ownerType    String // PLAYER_APPLICATION, PLAYER, COACH
  ownerId      String
  documentType String // DOB_PROOF, ID_CARD, LICENSE, CERTIFICATE, PHOTO
  fileUrl      String
  fileName     String
  fileSize     Int
  mimeType     String
  notes        String?

  verificationStatus String    @default("PENDING") // PENDING, VERIFIED, REJECTED
  verifiedBy         String?
  verifiedByUser     User?     @relation("DocumentVerifier", fields: [verifiedBy], references: [id])
  verifiedAt         DateTime?
  rejectionReason    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerType, ownerId])
  @@index([verificationStatus])
  @@map("documents")
}

// ============================================
// TOURNAMENT MODELS (Basic for Phase 1)
// ============================================

model Tournament {
  id           String @id @default(cuid())
  tournamentId String @unique
  name         String
  sport        String
  level        String // DISTRICT, STATE, NATIONAL
  genderCategory String?
  ageCategory    String?
  status         String @default("DRAFT") // DRAFT, PUBLISHED, ONGOING, COMPLETED

  // Identity & venue
  venue  String?
  format String? // KNOCKOUT, LEAGUE, GROUP_KNOCKOUT, etc.

  numberOfTeams Int?

  startDate            DateTime?
  endDate              DateTime?
  registrationDeadline DateTime?

  // Format & structure
  matchDurationMinutes Int?
  numberOfHalves       Int?
  pointsForWin         Int @default(3)
  pointsForDraw        Int @default(1)
  pointsForLoss        Int @default(0)
  tieBreakRules        String? // JSON or comma-separated list

  // Squad & eligibility
  minSquadSize      Int?
  maxSquadSize      Int?
  minAge            Int?
  maxAge            Int?
  requiredDocuments String? // JSON array of document type identifiers

  // Financial control
  entryFeeCents        Int?
  prizePoolDescription String?

  // Audit & lifecycle
  createdBy       String?
  createdByUser   User?   @relation("TournamentCreator", fields: [createdBy], references: [id])
  publishedBy     String?
  publishedByUser User?   @relation("TournamentPublisher", fields: [publishedBy], references: [id])
  publishedAt     DateTime?
  ongoingSince    DateTime?
  completedAt     DateTime?

  // Relations
  configSnapshots TournamentConfigSnapshot[]
  applications    TournamentApplication[]
  refereeAssignments TournamentRefereeAssignment[] @relation("TournamentReferees")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([sport])
  @@map("tournaments")
}

model TournamentConfigSnapshot {
  id             String     @id @default(cuid())
  tournamentDbId String
  tournament     Tournament @relation(fields: [tournamentDbId], references: [id], onDelete: Cascade)
  snapshotAt     DateTime   @default(now())
  snapshotBy     String?
  snapshotByUser User?      @relation("TournamentSnapshotCreator", fields: [snapshotBy], references: [id])
  configJson     String

  @@index([tournamentDbId])
  @@map("tournament_config_snapshots")
}

model TournamentApplication {
  id             String     @id @default(cuid())
  tournamentDbId String
  tournament     Tournament @relation(fields: [tournamentDbId], references: [id], onDelete: Cascade)

  coachId String
  coach   Coach   @relation(fields: [coachId], references: [id], onDelete: Cascade)

  teamName String
  notes    String?

  status      String   @default("APPLIED") // APPLIED, UNDER_REVIEW, APPROVED, REJECTED
  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  captainPlayerId String?
  captain         Player?  @relation("TournamentCaptain", fields: [captainPlayerId], references: [id])

  applicationPlayers TournamentApplicationPlayer[]

  @@unique([tournamentDbId, coachId])
  @@index([coachId])
  @@index([tournamentDbId])
  @@map("tournament_applications")
}

model TournamentApplicationPlayer {
  id            String                @id @default(cuid())
  applicationId String
  application   TournamentApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  playerId String
  player   Player  @relation("TournamentApplicationPlayer_Player", fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([applicationId, playerId])
  @@index([playerId])
  @@map("tournament_application_players")
}

model TournamentRefereeAssignment {
  id           String     @id @default(cuid())
  tournamentId String
  tournament   Tournament @relation("TournamentReferees", fields: [tournamentId], references: [id], onDelete: Cascade)

  refereeId String
  referee   User @relation("UserRefereeAssignments", fields: [refereeId], references: [id], onDelete: Cascade)

  assignedDate DateTime
  role         String // CENTER, LINESMAN, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tournamentId, assignedDate])
  @@index([refereeId])
  @@map("tournament_referee_assignments")
}

model Team {
  id       String  @id @default(cuid())
  teamId   String  @unique
  name     String
  location String?
  status   String  @default("ACTIVE")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coaches          TeamCoach[]
  creationRequests TeamCreationRequest[]

  @@index([teamId])
  @@map("teams")
}

// ============================================
// TEAM CREATION REQUESTS
// ============================================

model TeamCreationRequest {
  id        String @id @default(cuid())

  coachId   String
  coach     Coach  @relation(fields: [coachId], references: [id], onDelete: Cascade)

  requestedBy     String?
  requestedByUser User?  @relation("TeamRequestRequester", fields: [requestedBy], references: [id])

  name     String
  location String?

  status          String  @default("PENDING") // PENDING, APPROVED, REJECTED
  rejectionReason String?

  teamDbId String?
  team     Team?   @relation(fields: [teamDbId], references: [id])

  reviewedBy     String?
  reviewedByUser User?   @relation("TeamRequestReviewer", fields: [reviewedBy], references: [id])
  reviewedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([coachId])
  @@map("team_creation_requests")
}
